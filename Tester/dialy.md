# 12/22 1日目

## 問題概要

- 手札にカードがN枚あり、実行中のプロジェクトがM種類ある
	- カードは5種類ある
		- プロジェクトを進める労働カード2種類
		- プロジェクトをキャンセルして入れ替えるキャンセルカード2種類
		- プロジェクトと手札を強くする増資カード1種類
	- プロジェクトは残務量と価値を持つ
- 以下の操作をTターン行う
	- 手札を1枚使ってプロジェクトに変化を起こす
	- 新しいカードをK枚の中から1枚購入して手札に加える。
		- 1つは無料の通常労働カードであり、性能が一定
	- プロジェクトがM枚に満たなくなった分、ランダムにプロジェクトを補充する

## コーディング前の第一感めも

- すげー機械学習ゲーじゃね？
  - ちゃんと確率分布考えて解いていけば行けるのかなあ
  - あんまりヒューリスティック要素なさそう。愚直にとく。
    - 第一感真面目に計算するゲームに見えるからそんな面白くなさそうなんだけど、tomerunさんそんな問題出さないよな。多分ちゃんとやると面白い。
    - C#で戦いやすそうだなー、と思いつつ、MCTSは割と有力そうな手段っぽいのでやっぱ時間使うのかなあ。
- 何をすれば点数が伸びるんだ？
	- 増資カードがあるので倍々に点数が伸びていきそう？
	- 増資カードって強いのか？
		- 基本的に1ターン点数は、 (プロジェクト価値 / プロジェクト残務量) * 平均労働力
		- 増資カードによる変化は以下
			- プロジェクト価値は2倍
			- プロジェクト残務量も2倍
			- 平均労働力も2倍
		- じゃあ2倍やんけ。強い。
		- 無理して増資して金がなくなる、が弱いかも。要検討
	- 無料カードは強いのか？
		- L = 0で考える どうせ全部増えるのでLによって結論は変わらないはず。
			- 無料カードで得られる労働力を1とする
			- b=(2.0, 8.0)より、平均必要労働量が5くらい
			- 価値vなにこれ。わからん。
			- 分布出して見るか
    			- ![b=2](pic/b2.png)
    			- ![b=5](pic/b5.png)
    			- ![b=8](pic/b8.png)
  			- 分布大体全部一緒かな……？
  			- 残務量の平均はまぁ2^b/2くらいで、この分布が大体2^b
    			- とりあえず平均価値3で見積もっておくか
        			- 中央値は2だけど上振れが大きいので。 
			- 通常労働カードで得られる平均労働力は25、コストも25くらい
			- 1枚買って使用する価値は、
				- 無料カード: 2ターンで価値4の生産
				- 通常労働カード: 2ターンで価値75の生産
			- 無料カードクッソ弱い！
    - 通常労働カードと全力労働カードの比較
      - どんくらい全部のタスクをやるかによる気がする……
        - でも基本的に全力労働カードの方が強そう
        - 上の考察からたくさんお金使ってたくさん進めた方が吉っぽいし
      - キャンセル系カードの方が先に考察すべきっぽい？
    - キャンセルカードの価値
      - まずは分布が大切
        - 労働カードの分布から
          - 適当に平均30, 分散10のグラフを出してみる
            - ![ガウス分布](pic/gauss.png)
            - 効率に倍の差はつかなさそう？
        - プロジェクト1個を消費するために必要な平均ターン数は？
          - 通常労働の労働平均が25　（無料を1とする）
          - 全力労働の労働平均が25 * M
          - プロジェクトの残務平均が、b=5を採用するとして、32くらい
            - 1ターンとか2ターンとかで終わらね……？
          - キャンセルしてる暇があったら倒せ、みたいになりそうな気がする
            - 無料カードよりは流石に強い気がするけど。
            - K = 2とかでは買うし買うということは使う
    - 業務転換は？
      - かなり使いどころむずかしい
      - Mが多いときは全力労働が多分めちゃ強くない？
        - ってことは全力労働でプロジェクトがどんどん変わっていくので、やりかけプロジェクトが増えそう
          - ってことはキャンセルしたくないのが増えそう
      - 使いどころむずかしそうだなあ。すごい使いたいタイミングが来たら買うけど……くらい。
  - 何をやるにせよ強めの貪欲が必要な気がする
    - MCTSしたいんだけど、MCTSするには貪欲が強いのが絶対条件
      - とりあえず貪欲を組もう！
- 貪欲の組み方
  - とりあえずカード自体の価値とカード使用時に生み出す価値を適当に計算すれば良さそう。
    - カード価値高く見積もり過ぎるとカード使わなくなっちゃうので、カード価値の価値をちょっと低めに見積もって、いいカードどんどん使う感じにするのが良さげ

ここまでコード書かずにまったり考えて2時間くらい。短期コンだと絶対出来ない取り組み方だなあ。

- 増資カードってすぐに使っていいの？
  - 実はダメじゃね？と思い始めてる。カード購入にダイレクトに効いてくる
  - 増資カードを貯め込んで一気に増資！って戦略あるじゃんこれ
    - 増資カードの出現頻度や手札の数によっては温存あるわこれ
      - あるか？ ないかも
      - Lがいくつになってるかより、増資カードの入手数+Lが大切だったりしない？
        - するかも
      - そんな考えなくていいかも。
        - 基本即使用で実装しようと思ってたけど、一応やめようかな……。
        - 貪欲にやる時は即使用でいいと思う


### Submit 1：23.207 3位

- 雑にステータスの評価値を書いて、それを元に貪欲をした
- その後、何ターンか適当にシミュレートしてみるのを書いて提出した
  - 適当に840ケースくらい試した。そんなに変わらないっぽい
  - 0001がサンプル、0002が貪欲のみ、0003がランダム生成したデータで先読み
    - ![スコア](pic/score1.png)
- 先読みの時にXを学習してみたけど意味なし。ぐぬぬ。
- 手元でサンプルが0.027なのに対して順位表だと0.662くらいある気がしてる。これデータ生成ちゃんとあってる？
  - なんかやたら合計点数が少ない気がする
  - ProjectやらmoneyやらがオーバーフローしてそうΣ
    - 大きいテストで0点続出だったっぽい……？
    - ![スコア](pic/score2.png)
  - でもTesterだと大半L=20になるのにvisualizerからとってきたデータだと大半L=20いかないなあ。謎。
  
### Submit 2：27.404 2位

- 良い貪欲を見つけるゲーでクソみたいな貪欲書いてるからまぁまだ大した点数が出ないのは当然だけど、上にKiriさんがいるのはさすがだなあ(37.670)
- テスト改善したいけどその前にローカルと実際のテストデータにめっちゃ差があるのをなおしたい！
  - 調べてみたら普通に生成ミスでした。
  - サンプルが0.68点に。ってことは小さいケースでも普通に負けてるね。

- 色々直したけど貪欲と大差ないものしか出来て無くない？
  - ただの貪欲によく負ける。そもそもやり方がまずい？
  - ちょっと長い時間回してみるかあ。実行時間10倍を0007で。
  - 10倍 vs 通常 vs 貪欲 = 86 vs 62 vs 50になった
    - 10倍強いけどKiriさんが130くらいのスコア出してるんだよなあ……。
    - やっぱ貪欲単体で100くらい出せる計算式にしないとダメそうな気がする。

- 状態の評価がむずい
  - 以下の要素を評価しないといけない
    - 残金
    - レベル
    - 残りターン
    - 残っているプロジェクト
    - 残っているカード
  - 順番に考えてみる
    - 残金
      - そのまま……でいいのか？
      - 残り金額が少なくて身動きが取れない状態にはペナルティを与えたさがある
    - レベルと残りターン
      - レベルは基本的にすぐ上げたいけど上に書いてある残り金額パターンだけ怖い
      - 残りターンはレベルと合わせて処理することが多め。最後だけ動きが特殊だけど本質的じゃないと思う
      - (2^レベル)*残りターン*適当な定数、とかを補正で入れとけば大体あげたいし後半やめとこってなりそう
    - 残っているプロジェクト
      - 残りHPと価値Vについて考えた時に、
        - 基本的にこのゲームは価値と労働力が釣り合ってるわけで、HP>Vのものはゴミ
        - ってことは大体 V - HPがそのプロジェクトの価値
          - でもこれだとどれ削っても価値が同じってことになっちゃう
        - そのプロジェクトの完遂したさ度合い、みたいなのを入れる？
          - 絶対入れる→1
          - 積極的ではないけどまぁやっても良い→0.8
          - こんなん使わん→0.5
            - 存在することがマイナスの価値だよ、というのをちゃんと示すために0にしない方が良さそう
              - キャンセルカードとかのため
              - 業務転換カードが有効に使えることはあるのか……？
          - なんかいい感じに傾斜つけたいな
            - V=HPのとき0.8
            - HP=0のとき1
            - 1-HP/V*0.2で良い？
              - こういうの事例出して考えないとわかんなくなる
              - プロジェクトが4つ
                - V=100, HP=3
                - V=100, HP=101
                - V=100, HP=200
                - V=10, HP=3
              - それぞれ重要度計算して(V-HP)掛けるとこんな感じ
                - 重要度: 0.994	 価値: 96.418
                - 重要度: 0.798	価値: -0.798
                - 重要度: 0.600 価値: -60.00
                - 重要度: 0.94 価値: 6.58
              - それぞれにPower=2を使う
                - 重要度: 0.998 価値: 98.802 価値上昇:2.384
                - 重要度: 0.802 価値: 0.802 価値上昇:1.6
                - 重要度: 0.604 価値: -59.192 価値上昇:0.808
                - 重要度: 0.98 価値: 8.82 価値上昇:2.24
              - 良さそう。ちゃんとHP少ないやつが先に使われるし、Vがでかい方が使われている。
    - 残っているカード
      - 通常カード
        - 価値=Powerで基本良い
          - 上の重要度の関係で価値上昇が序盤小さくなってるのが難しい
            - 価値=2の時、上の例で言うと、1,4番目には使えるけど2,3番目には使えなくなっちゃう
              - 3には使えなくていいけど2には使った方が良さげだよね。
            - 重要度と対応させる意味では適当な倍率かけておいた方がいいかも
              - 0.8から頑張って欲しいんだから0.79かける
                - Cost = 80, V = 100の購入がマイナスになっちゃう
                  - 実際この辺の価値どうなのかね。
                  - 一回で20分のプラスを生むのは強いし、ぴったり消化できない弱さもあるし。なやまし。
      - 全体攻撃カード
        - 通常カードの扱いにMをかけて、適当に減衰(0.7倍くらい？)させればいいかなあ。
      - 他
        - とりあえずカード価値0でいいや。即使用以外はややこしい気がするので。


# 12/23 2日目

いとこの結婚式なのであんまり作業ができなさそう。

- 寝る前に実行時間10倍と100倍を試してみた
![スコア](pic/score3.png)

- 実行時間足りてないだけやんけ！！！
- ほんと？
  - 並列実行が悪さしてるかもね
  - 思ったより実行時間が大切そう
    - 差分評価を実装する？
  - 並列で走る数をめちゃ減らしてみた
    - 評価10倍の時とおんなじくらいになってる！
      - ゴミ！！！
    - ってことは時間を増やせば上位に追いつけるはまやかしね。
      - とはいえ実装することが悪くはなさそう。スコア1.5倍にはなるんだし。


- 結婚式から帰った！
  - 差分評価を実装するぞ！
  - した！
  
### Submit 3: 23.209 6位 (Ver28)

- これ実行時間上げたら上位に追いつく水準なんだろうか
  - やってみよ！（Ver29）
  - 全然伸びんかった。いや2割増しくらいではあるんだけど。
- 見てると「なんでそっち選んだんだろう」ってのが結構ある
  - AのあとB、と、BのあとA、が、おんなじ評価になってるのが原因っぽい？
    - どっちの方が先にやるべきか、みたいなのがない
  - しっかり探索出来てれば探索した方がいいんだろうけど、基本的には1手目評価が高いやつを選んだ方が良さそうよね。
    - そこを評価に足した(Ver30)
      - 普通に悪そう。削除。

- そろそろ根本的なアルゴリズムに向き合わないといけないかもしれない
  - ランダムな入力に対して貪欲シミュレーションをしている
  - そもそもレベルが上がる入力とレベルが上がらない入力の違いって何？
    - N, M, Kについて出力してたけどなんか違う気がする。
    - Guessの中身を見てみるか
      - Seed1 Score = 61088 Level = 5 N = 7 M = 8 K = 2 GP = 0
        - N, Mは良さそう。Kが悪いけど。
        - Guess: 487,204,209,120,31
      - Seed8 Score = 978214229 Level = 18 N = 2 M = 4 K = 4 GP = 0
        - 条件そんなに良さそうじゃないのにスコアが超高い
        - Guess: 510,1737,151,333,318
        - 全体攻撃かレベルアップだな……
      - Seed10 Score = 5251400 Level = 11 N = 5 M = 8 K = 4 GP = 0
        - Guess: 773,415,386,926,549
        - これは全体攻撃の数が重要だ！
- ちょっと全体攻撃の評価を変えて実行してみる
	- とりあえずwork×M×0.8で実行(Ver31)
    	- work×M×0.7(Ver32)
    	- work×M×0.9(Ver33)
	- 掛け算してるけど、この掛け方はおかしい気がしてる
    	- 1+0.8+0.8+...って感じな気がする
    	- M=2の時はもっと重くて良いしM=8の時とかはもっとダメそう。
        	- Seed8はM=4で動いてるし、M=4の時のバランスが0.8くらいなのかな
    	- そもそも今カード価値に0.83かけてるから、要求が0.6倍とかになってて鬼……。
        	- カード購入と使用がセットなので、即使用パターンくらいしか許容されなさそう。


![スコア](pic/score4.png)

- 実行終わった
  - 0.7は低すぎて論外、0.9は良くなったり悪くなったりで傾向がはっきり出てる感じ。
    - Mについて
      - M=2、M=3は爆伸び
      - M=7,8はヤバげ
      - M=5くらいからバランス良い感じ
    - Nについて
      - 基本的には差がない……？
      - ブレがでかくて結果の見方がむずかしい！
        - そろそろテスト数増やす……？
    - Kについて
      - わからん。多分関係ない
    - まぁ考察通りMについてみれば良さそう。
      - M=2の時1.9くらいにしたい
      - M=5の時五分っぽいので4くらいにしたい
      - 2,3,4,5に対して、-0.1, -0.3, -0.6, -1.0で良い感じ……？
        - -M(M-1)/20.0
      - M=2の時は「未来に備えて買っておく」を許容する方向に
      - M=8の時は「即使用したい時以外は絶対買わん」という方向に
      - うごかしてみよう(Ver34)
        - まぁ狙い通り伸びたけど微差……
  
  ![スコア](pic/score5.png)

- こういう修正を行うタイミングではまだなくない？50%くらい伸ばさないといけないのに2%伸ばしてどうすんねん。
- 根本的なアルゴリズム改良、やるならどうするかなあ……。
  - 今やってることの整理
  - 「1手」を「買うものを決めて使うプロジェクトを選ぶ」の3つ組とする
  -	アルゴリズム
  	- まず1手全探索、評価値を列挙
    - 列挙したののうち上位A個を候補に採用
    - B種類の未来のプロジェクト、未来のカードをランダム生成し、Cターン貪欲でやってみて、スコアの和を計算
    - A個の候補のうち、スコアの和が一番多いのの勝ち
      - ……正しいのは和じゃなくない？積っぽくない？
      - 積だと溢れるからlogの和を取ると良さそうな気がする
        - 破綻して終わる奴を防ぎたいのと、レベルが上がった奴だけ重みづけが異常に上がる式は良くない気がする
      - そもそもレベルが上がった奴を評価するシステムってレベル上がる奴買えるなら絶対買っちゃうよね
        - type=4の期待度から、どれくらいで買えそう、って相場を計算して、直近Kターンで買える処理は即出来る扱いみたいなことする……？
          - やってみた(Ver35)
          - さすがにそれだとターン不利だから1ターンか2ターン分くらい消費して計算しないと合わなさそう。
            - スコアも2%くらい落ちた
          - 2ターン消費扱いにした(Ver36)
            - そもそも今1ターンで発生する収益を2^Lにしてるけど、これは妥当なんか……？
            - 無料で得られるのがこれだけど、これより良いものが得られることは多いので、もうちょい上げてもいいのよねえ。
              - ってことは2ターン消費扱いにしても2*2^Lしか変わらんのだから効果めちゃ薄いやん。ぬーん。
              - やっぱスコア良くなかった
      - とりあえず和を積(logの和)にするやつやってみる(Ver36 被せちゃった？)
        - ほどほどに伸びた。ほどほど。
        - Chromeのタブ減らしたから伸びたとか言われてもこれ分からんな……。
          - 前のやつで実行してみる(Ver39)
          - 37を実行してみる(Ver40)
          - 下がったやんけ！
            - 誤差ってことにしよ……。

根本的なアルゴリズムの話に戻る
- 貪欲シミュレーションをたくさんやるのがダメそう？
  - でも未来はわかんないから先読みするのも変な話だよね。貪欲が十分強いならこれで良い。
    - そもそも先読みで出せるものを貪欲で出せるようにしたい……。
      - そういう文脈で言うと機械学習っぽい？
    - とりあえず機械学習の前に人間学習。貪欲でこれが良かったけど実際は違った！みたいなのを列挙してみよう
  
### 観察フェーズ Seed 0

```
Turn 1 select 1
Sell Cards:
id0 Type:0 Power:1 Cost:0
id1 Type:3 Power:0 Cost:2
id2 Type:1 Power:45 Cost:62
My Cards:
id0 Already Used
id1 Type:0 Power:39
Projects:
id0 HP: 15 Value: 25
id1 HP: 4 Value: 7
Greedy Choice: Buy Card 0, Use Card 0 for Project 0
Search Choice: Buy Card 0, Use Card 0 for Project 1
```

- 初手から違うやんけ！
- N=2だと手が狭いから苦しんでるのがわかる……。
  - 7/4 > 25/15に見えるし、なんでこれid1をGreedyで選ばないんだ？
    - 評価関数間違ってない？
    - みた。「ゴール時の評価」を増やすために、ベースを増やす処理を行ってて、両方分子から6を引いてる
      - 激ヤバやんけ。
      - return (long)((V - HP - (Math.Max(1, 8L - F.N) << L) * 1) * needValue * 100L);
    - とりあえずこれ除くか……。(Ver41)
    - でもこれちゃんと後のGreedyによって解消してるの偉すぎだなあ。（1度選んだ奴は連続して選んで倒そうぜ！をシミュレート側に入れてる）
      - （追記）Ver41結構落ちた。なんでや！
        - Nが小さいケースでちょっと伸びてて、Nが大きいケースで死んでいる
          - これ多分「終わらせられるものを早く終わらせる」にボーナスつけようとして評価ミスった系じゃないかな……。
            - 不等号を逆にしてみた。「終わりそうなやつを削る」って方向性。こっちのがいいでしょ。
            - スコア1/3になったんですが……。
        - どういう気持ちで作った評価関数なんだろこれ。
          - 価値を低く見積もっておくと完成した時に嬉しい、って奴かな……？
            - そういう意味では探索で結果的にたどり着けてるし良い気もする。
        - とりあえずスコアのみで調整しながら考える (Ver43)
          -  ゴールすることによる価値は外から与えれば良くない？
             -  与えすぎるとバランス崩壊しちゃうのかも？
             -  価値を不当に低く見積もるよりは、撃破インセンティブを一時的に用意してあげて貪欲で選ばれやすくしてあげる、みたいな方向性のが良さそう？
             -  わからん。
             -  「ダメージを与えすぎると無駄になる」というのが結構いたいんだけど、とはいえ中途半端なものが残るのも良くないから、って感じでバランス調整してるんだよな多分。
                - Nが大きいと調整可能だからバランス調整可能かな、と思って重みづけを軽くし、Nが小さいとバランス調整しづらいかな、と思って重くしたのかな
                - でもなんかめっちゃ裏目に出てそう
          - なんか調整したらスコアめちゃ伸びた。うれしい。

実行しなおし

```
Turn 7 select 1
Sell Cards:
id0 Type:0 Power:1 Cost:0
id1 Type:3 Power:0 Cost:6
id2 Type:0 Power:18 Cost:6
My Cards:
id0 Already Used
id1 Type:0 Power:44
Projects:
id0 HP: 14 Value: 25
id1 HP: 152 Value: 72
Greedy Choice: Buy Card 1, Use Card 0 for Project 0
Search Choice: Buy Card 2, Use Card 0 for Project 0
```

- これはカードの評価の話
- Type3が強いと思ったらそんなことありませんでした、みたいな話。
  - なんでこれType3だと思ってるんだろ。id1がゴミだから？
  - パっと見改善しなさそうなのでとても正しそう。
    - Type3の評価どうしようね。M=2なら使いどころ全然あると思うし捨てる必要はなさそうなんだけど。
    - 多分マイナスのものの評価値が高すぎるのが原因なんだろうなあ。
      - 評価値の要見直し。

```
Sell Cards:
id0 Type:0 Power:1 Cost:0
id1 Type:0 Power:4 Cost:5
id2 Type:0 Power:4 Cost:3
My Cards:
id0 Already Used
id1 Type:0 Power:44
Projects:
id0 HP: 71 Value: 55
id1 HP: 37 Value: 36
Greedy Choice: Buy Card 0, Use Card 1 for Project 1
Search Choice: Buy Card 2, Use Card 1 for Project 1
```

- Power - Costが同じ中でどっちを買って使うかの話
- 基本的には無駄になるのを恐れて0より2の方が評価が落ちるんだけど、高速に回すという観点においてはPower>Costなのよね。
- 無駄になるのを恐れず買っちゃうのをデフォルトにした方が良い気もする
- 探索結果を予想して機械学習、みたいなこと言ってたけど、「アグレッシブに攻めてみてダメかどうかは探索で確認」って思想の方が良い気もしてきた。そのための探索。
  - 日和った評価関数を捨てろ！！！


評価関数の調整をするぞ！

- 負の奴の存在価値をめっちゃ下げてみる？
  - なんかめちゃ悪くなってそう。
  - 多分キャンセル系のカードの優先度が落ちて、その結果厳選が全然効かなくなってる。
- とりあえず日和った調整を捨てた
  - 優先度の基準を0.8から0.95に
  - PowerとHPのバランスを0.83倍から0.97倍に(Ver45)
    - これ1つ目>2つ目なのおかしくね？
    - 0.91倍くらいにしてみる(Ver46)
    - どっちも悪そう
- 隠れ変数Xに依存し過ぎな気がしてきたなあ。
  - 今結局、点数が大きいケースで落としてるのか、点数が小さいケースで落としてるのかもよくわからない。
    - 点数をlogスケールで分けてそれごとの得点分布を出す……？
      - 直感的には良さそう。
      - Xに依存した戦略も多分取らないといけないんだろうなあ。






  




